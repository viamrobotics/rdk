<html>
  <head>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <script src="./static/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script>
      function makeApiCall(path, cb, data) {
          if (!cb) {
              theData.error = "";
              theData.res = {};
          }

          var options = {
              method : "POST",
              headers : {}
          }

          if (data) {
              options.headers["Content-Type"] = "application/json"
              options.body = JSON.stringify(data)
          }
          
          fetch( path, options)
              .then(function(response) {
                  return response.json();})
              .then(function(response) {
                  if ("err" in response ){
                      theData.error = JSON.stringify(response);
                  } else if (cb) {
                      cb(response);
                  } else {
                      theData.res = response;
                  }
              });
      }
      
      {{ range $view := .Views }}
        {{ jsSafe $view.JavaScript }}
      {{ end }}

      function fixArms(old) {
          var n = [];
          for (var i=0; i<old.length; i++) {
              const [armName, armValue] = old[i];
              var newArm = { name : armName, pieces : [] };

              var fields = [ "x", "y", "z", "rX", "rY", "rZ"];
              for (var j=0; j<fields.length; j++ ){
                  newArm.pieces.push( { grid : fields[j],
                                        joint : j,
                                        gridValue : armValue.gridPosition[fields[j]],
                                        jointValue : armValue.jointPositions.degreesList[j],
                                      });
              }
              
              n.push(newArm);
          }
          return n;
      }

      firstResult = false;
      
      async function updateStatus(rawStatus) {
          theData.rawStatus = rawStatus;

          var status = {}

          // make vue friendly
          status.armsMap = rawStatus.armsMap;
          status.basesMap = rawStatus.basesMap;
          status.grippersMap = rawStatus.grippersMap;
          status.boardsMap = rawStatus.boardsMap;

          status.armsMap = fixArms(status.armsMap);

          if (!firstResult) {
            console.log(status);
            firstResult = true;
          }

          theData.status = status;
      }
      
      function startup() {
          theData = {
              error : "",
              res : {},
              rawStatus : null,
              status : {}
          };
          theApp = new Vue({
              el: '#app',
              delimiters: ['${', '}'],
              data: theData,
              methods : {
                  armGridInc : function(idx, field, amount) {
                      const [name, value] = theData.rawStatus.armsMap[idx];
                      var old = value.gridPosition;
                      var newPosition = Object.assign({}, old);
                      newPosition[field] += amount;
                      makeApiCall("/api/arm/MoveToPosition", null, { Name : name, To : newPosition});
                  },
                  armJointInc : function(idx, field, amount) {
                      const [name, value] = theData.rawStatus.armsMap[idx];
                      var old = value.jointPositions;
                      var newPosition = Object.assign({}, old);
                      newPosition.degreesList[field] += amount;
                      makeApiCall("/api/arm/MoveToJointPositions", null, { Name : name, To : newPosition});
                  },
                  armHome : function(idx, field, amount) {
                      const [name, value] = theData.rawStatus.armsMap[idx];
                      var old = value.gridPosition;
                      var newPosition = {};
                      for (var k in old) {
                          newPosition[k] = 0.0;
                      }
                      makeApiCall("/api/arm/MoveToPosition", null, { Name : name, To : newPosition});
                  },
                  gripperAction : function(name, action) {
                      var path = "/api/gripper?name=" + name + "&action=" + action;
                      makeApiCall(path);
                  },
                  servoMove : function(idx, servoIdx, amount) {
                      const [boardName, boardValue] = theData.rawStatus.boardsMap[idx];
                      const [servoName, servoValue] = boardValue.servosMap[servoIdx];
                      var angle = servoValue.angle + amount;
                      var path = "/api/board/" + boardName + "/servo?name=" + servoName + "&angle=" + angle;
                      makeApiCall(path);
                  },
                  motorButton: function(board, motor, cmd) {
                      var path = "/api/board/" + board + "/motor?name=" + motor + "&" + cmd;
                      makeApiCall(path);
                  },
                  doAction : function(name) {
                      var path = "/api/action?name=" + name;
                      makeApiCall(path);
                  },
                  baseAction : function(name, action) {
                      var path = "/api/base?name=" + name + "&" + action + "&speed=" + document.getElementById("speed").value;
                      path = path.replace("DIS", document.getElementById("distance").value);
                      makeApiCall(path);
                  }
              }
          })

          // TODO(erd): make duration configurable
          const streamReq = new robotApi.StatusStreamRequest();
          streamReq.setEvery((new proto.google.protobuf.Duration()).setNanos(500000000));
          const statusStream = robotService.statusStream(streamReq);
          statusStream.on('data', function(response) {
            // toObject gives annoying suffixes; see https://github.com/protocolbuffers/protobuf/issues/6773
            updateStatus(response.getStatus().toObject());
          });
          statusStream.on('status', function(status) {
            console.log("error streaming robot status");
            console.log(status.code, " ", status.details);
          });
          statusStream.on('end', function(end) {
            console.log("done streaming robot status");
          });
      }
      
    </script>
  </head>
  <body onLoad="startup()">
    <div id="app">
      <div id="actions">
        {{range $r := .Actions}}
        <button v-on:click="doAction('{{$r}}')">{{$r}}</button>
        {{end}}
      </div>      

      <div style="font-color: red">${ error }</div>

      <!-- ******* BASE *******  -->
      <div class="base" v-for="base in status.basesMap" :key="base[0]">
        <h3>${base[0]}</h3>
        <ul>
          <li><button v-on:click="baseAction(base[0], 'distanceMillis=DIS')">Forward</button></li>
          <li><button v-on:click="baseAction(base[0], 'distanceMillis=-DIS')">Backward</button></li>
          <li><button v-on:click="baseAction(base[0], 'angle=15')">Spin Clockwise</button></li>
          <li><button v-on:click="baseAction(base[0], 'angle=-15')">Spin Counterclockwise</button></li>
        </ul>
        
        Speed (mm per sec): <input id="speed" name="speed" value="300"/><br>
        Distances (mm): <input id="distance" name="speed" value="500"/><br>
      </div>

      <!-- ******* ARM *******  -->
      <div class="arm" v-for="(arm, index) in status.armsMap" :key="arm[0]">
        <h3>Arm ${arm[0]}</h3>
        <table border="1">
          <tr>
            <th colspan="4"><h5>GRID</h5></th>
            <th colspan="4"><h5>JOINTS</h5></th>
          </tr>
          <tr v-for="aa in arm.pieces" :key="aa.joint">
            <th>${aa.grid}</th>
            <td>
              <button v-on:click="armGridInc( index, aa.grid, -2 )">--</button>
              <button v-on:click="armGridInc( index, aa.grid, -1 )">-</button>
              <button v-on:click="armGridInc( index, aa.grid, 1 )">+</button>
              <button v-on:click="armGridInc( index, aa.grid, 2 )">++</button>
            </td>
            <td>${aa.gridValue}</td>

            <td></td>
            
            <th>Joint ${aa.joint}</th>
            <td>
              <button v-on:click="armJointInc( index, aa.joint, -2 )">--</button>
              <button v-on:click="armJointInc( index, aa.joint, -1 )">-</button>
              <button v-on:click="armJointInc( index, aa.joint, 1 )">+</button>
              <button v-on:click="armJointInc( index, aa.joint, 2 )">++</button>
            </td>
            <td>${aa.jointValue}</td>
          </tr>
          <tr>
            <th colspan="8"> 
              <button v-on:click="armHome( index)">Home</button>
            </th>
          </tr>

        </table>
      </div> 
      
      <!-- ******* GRIPPER *******  -->
      <div class="gripper" v-for="gripper in status.grippersMap" :key="gripper[0]">
        <h3>Gripper ${ gripper[0] }</h3>
        <ul>
          <li><button v-on:click="gripperAction( gripper[0], 'open')">Open</button></li>
          <li><button v-on:click="gripperAction( gripper[0], 'grab')">Grab</button></li>
        </ul>
      </div>

      <table>
        <tr>
          <td><img id="i0" src=""/></td>
          <td><img id="i1" src=""/></td>
          {{ range $view := .Views }}
          <td>
            {{ htmlSafe $view.Body }}
          </td>
          {{ end }}
        </tr>
      </table>
      
      <!-- ******* BOARD *******  -->

      <div class="board" v-for="(board, boardIndex) in status.boardsMap" :key="board[0]">
        <h3>Board ${board[0]}</h3>
        <table border="1">
          
          <tr><th colspan="2">Motors</th></tr>
          <tbody v-for="m in board[1].motorsMap" :key="m[0]">
            <tr>
              <th>${m[0]}</th>
              <td>
                <button v-on:click="motorButton(board[0], m[0], 'd=backward&s=64')">--</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=backward&s=32')">-</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=none&s=0')">0</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=forward&s=32')">+</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=forward&s=64')">++</button>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <button v-on:click="motorButton(board[0], m[0], 'd=backward&s=64&r=10')">-10</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=backward&s=32&r=1')">-1</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=forward&s=32&r=1')">+1</button>
                <button v-on:click="motorButton(board[0], m[0], 'd=forward&s=64&r=10')">+10</button>
              </td>
            </tr>
            
            <tr>
              <td align="right">On</td>
              <td>${m[1].on}</td>
            </tr>
            <tr>
              <td align="right">PositionSupported</td>
              <td>${m[1].positionSupported}</td>
            </tr>
            <tr>
              <td align="right">Position</td>
              <td>${m[1].position}</td>
            </tr>


          </tbody>

          <tr><th colspan="2">Analogs</th></tr>
          <tr v-for="a in board[1].analogsMap" :key="a[0]">
            <th>${a[0]}</th>
            <td>${a[1].value}</td>
          </tr>

          <tr><th colspan="2">DigitalInterrupts</th></tr>
          <tr v-for="di in board[1].digitalInterruptsMap" :key="di[0]">
            <th>${di[0]}</th>
            <td>${di[1].value}</td>
          </tr>

          <tr><th colspan="2">Servos</th></tr>
          <tbody v-for="(s, servoIndex) in board[1].servosMap" :key="s[0]">
            <tr><th>${s[0]}</th><td>${s[1].angle}</td></tr>
            <tr>
              <td></td>
              <td>
                <button v-on:click="servoMove( boardIndex, servoIndex, -10)">-10</button>
                <button v-on:click="servoMove( boardIndex, servoIndex, -1)">-1</button>
                <button v-on:click="servoMove( boardIndex, servoIndex, 1)">1</button>
                <button v-on:click="servoMove( boardIndex, servoIndex, 10)">10</button>
              </td>
            </tr>
          </tbody>
          
        </table>
      </div> <!-- end boards -->

      <div>${res}</div>
    </div> <!-- end vue app -->

    

    
  </body>
</html>

