<html>
  <head>
    <script>
      function roverAction(action) {
          var path = "/api/base?" + action + "&speed=" + document.getElementById("speed").value;
          makeApiCall(path);
      }

      function doAction(name) {
          var path = "/api/action?name=" + name;
          makeApiCall(path);
      }
      
      function makeApiCall(path, cb) {
          if (!cb) {
              document.getElementById("err").innerHTML = "";
              document.getElementById("res").innerHTML = "";
              console.log(path);
          }

          fetch( path, { method: "POST"})
              .then(function(response) {
                  return response.json();})
              .then(function(response) {
                  if ("err" in response ){
                      document.getElementById("err").innerHTML = JSON.stringify(response);
                  } else if (cb) {
                      cb(response);
                  } else {
                      document.getElementById("res").innerHTML = JSON.stringify(response);
                  }
              });
      }

      window.onkeypress = function(k) {
          switch (k.key) {
          case "s":
              roverAction("stop=true");
              break;
          }

      }

      function armInc(arm, action, mode) {
          if (!mode) {
              mode = "grid"
          }
          var path = "/api/arm?num=" + arm + "&mode=" + mode + "&action=inc&" + action;
          makeApiCall(path);
      }

      function gripperAction(num, action) {
          var path = "/api/gripper?num=" + num + "&" + action;
          makeApiCall(path);
      }
      
      {{ range $view := .Views }}
        {{ jsSafe $view.JavaScript }}
      {{ end }}

      function updateJointView(arm) {
          makeApiCall("/api/arm?mode=joint&num=" + arm, function(response) {
              var j = response["joints"];
              for ( var i=0; i<j.length; i++) {
                  var id = "arm_j_" + arm + "_" + i;
                  document.getElementById(id).innerHTML = Number(j[i]).toFixed(2);
              }
          });
          setTimeout(updateJointView, 500, arm);
      }

      function updateGridView(arm) {
          makeApiCall("/api/arm?mode=grid&num=" + arm, function(response) {
              for ( var i in response) {
                  var id = "arm_c_" + arm + "_" + i;
                  var e = document.getElementById(id);
                  if (e) {
                      e.innerHTML = Number(response[i]).toFixed(1);
                      if (i.length == 1) {
                          e.innerHTML += " mm";
                      }
                      if (i.length == 2) {
                          e.innerHTML += " deg";
                      }
                  }
              }
          });
          setTimeout(updateGridView, 500, arm);
      }

      function jointCopy(arm) {
          makeApiCall("/api/arm?mode=joint&num=" + arm, function(response) {
              var j = response["joints"];
              for ( var i=0; i<j.length; i++) {
                  var id = "arm_ji_" + arm + "_" + i;
                  document.getElementById(id).value = Number(j[i]).toFixed(2);
              }
          });
      }

      function jointSet(arm) {
          var path = "/api/arm?mode=joint&num=" + arm + "&action=abs";
          makeApiCall("/api/arm?mode=joint&num=" + arm, function(response) {
              var j = response["joints"];
              for ( var i=0; i<j.length; i++) {
                  var id = "arm_ji_" + arm + "_" + i;
                  path = path + "&j" + i + "=" + document.getElementById(id).value;
              }
              makeApiCall(path);
          });
      }

      function gridCopy(arm) {
          makeApiCall("/api/arm?mode=grid&num=" + arm, function(response) {
              for ( var i in response) {
                  var id = "arm_ci_" + arm + "_" + i;
                  var e = document.getElementById(id);
                  if (e) {
                      e.value = Number(response[i]).toFixed(1);
                  }
              }
          });
      }

      function gridSet(arm) {
          var path = "/api/arm?mode=grid&num=" + arm + "&action=abs";
          makeApiCall("/api/arm?mode=grid&num=" + arm, function(response) {
              for ( var i in response) {
                  var id = "arm_ci_" + arm + "_" + i;
                  var e = document.getElementById(id);
                  path = path + "&" + i + "=" + document.getElementById(id).value;
              }
              makeApiCall(path);
          });
      }

      function boardAction(type, boardName, typeName, action) {
          var path = "/api/board/" + boardName + "/" + type + "?name=" + typeName + "&" + action;
          console.log(path);
          makeApiCall(path);
      }

      function updateBoardView(name) {
          makeApiCall("/api/board/" + name, function(response) {

              function fillIn(longName, shortName) {
                  for (var a in response[longName] ) {
                      var id = "board_" + shortName + "_" + name + "_" + a;
                      var e = document.getElementById(id);
                      e.innerHTML = response[longName][a];
                  }
              }
              fillIn("analogs", "a");
              fillIn("digitalInterrupts", "di");
              fillIn("servos", "s");
          });
          setTimeout(updateBoardView, 500, name);
      }
      
    </script>
  </head>
  <body>
    <div id="actions">
      <button onclick="doAction('RandomWalk')">Random Walk</button>
    </div>
    <div id="err" style="font-color: red"></div>
    {{ range $b := .Bases }}
    <div class="base">
      {{ $b }}
      <ul>
        <li><button onclick="roverAction('distanceMM=200')">Forward</button></li>
        <li><button onclick="roverAction('distanceMM=-200')">Backward</button></li>
        <li><button onclick="roverAction('angle=15')">Spin Clockwise</button></li>
        <li><button onclick="roverAction('angle=-15')">Spin Counterclockwise</button></li>
      </ul>

      Speed (mm per sec): <input id="speed" name="speed" value="500"/><br>
    </div>
    {{ end }}

    {{ range $idx, $a := .Arms }}
    <div class="arm">
      <h3>Arm {{ $a }}</h3>
      <script>
        updateJointView({{$idx}})
        updateGridView({{$idx}})
      </script>
      <table>
        <tr>
          <th><h5>GRID</h5></th>
          <th><h5>JOINTS</h5></th>
        </tr>
        <tr>
          <td>
            <ul>
              {{ template "C" list $idx "x" 2}}
              {{ template "C" list $idx "y" 2}}
              {{ template "C" list $idx "z" 2}}
              {{ template "C" list $idx "rx" 1}}
              {{ template "C" list $idx "ry" 1}}
              {{ template "C" list $idx "rz" 1}}
              <button onclick="gridCopy({{ $idx }})">Copy values</a>
              <button onclick="gridSet({{ $idx }})">Set values</a>
            </ul>
          </td>
          <td>
            <ul>
              {{template "J" list $idx 0}}
              {{template "J" list $idx 1}}
              {{template "J" list $idx 2}}
              {{template "J" list $idx 3}}
              {{template "J" list $idx 4}}
              {{template "J" list $idx 5}}
              <button onclick="jointCopy({{ $idx }})">Copy values</a>
              <button onclick="jointSet({{ $idx }})">Set values</a>
            </ul>
          </td>
          <td>
            <ul>
              <li><button onclick="makeApiCall('/api/arm?num={{$idx}}&mode=joint&action=abs&j0=0&j1=0&j2=0&j3=0&j4=0&j5=0')">Home</a></li>
            </ul>
          </td>
        </tr>
      </table>
    </div>
    {{ end }}

    {{ range $idx, $g := .Grippers }}
    <div class="gripper">
      Gripper {{ $g }}
      <ul>
        <li><button onclick="gripperAction({{ $idx }}, 'action=open')">Open</button></li>
        <li><button onclick="gripperAction({{ $idx }}, 'action=grab')">Close</button></li>
      </ul>
    </div>
    {{ end }}

    
    <table>
      <tr>
        <td><img id="i0" src=""/></td>
        <td><img id="i1" src=""/></td>
        {{ range $view := .Views }}
          <td>
          {{ htmlSafe $view.Body }}
          </td>
        {{ end }}
      </tr>
      </table>

    {{ range $b := .Boards }}
    <h3>Board {{$b.Name}}</h3>
    <table border="1">
      <tr><th>Model</th><td>{{$b.Model}}</td></tr>
      
      {{if $b.Motors }}
      <tr><th colspan="2">Motors</th></tr>
      
      {{ range $m := $b.Motors }}
      <tr>
        <th>{{$m.Name}}</th>
        <td>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=backward&s=64')">--</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=backward&s=32')">-</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=none&s=0')">0</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=forward&s=32')">+</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=forward&s=64')">++</button>
        </td>
      </tr>
      {{ if $m.Encoder }}
      <tr>
        <td></td>
        <td>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=backward&s=64&r=10')">-10</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=backward&s=32&r=1')">-1</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=forward&s=32&r=1')">+1</button>
          <button onclick="boardAction('motor', '{{$b.Name}}', '{{$m.Name}}', 'd=forward&s=64&r=10')">+10</button>
        </td>
      </tr>
      {{end }}
      
      {{ end }}
      {{end}}
    
      {{if $b.Analogs }}
      <tr><th colspan="2">Analogs</th></tr>
      {{ range $a := $b.Analogs }}
      <tr><th>{{$a.Name}}</th><td id="board_a_{{$b.Name}}_{{$a.Name}}"></td></tr>
      {{ end }}
      {{end}}

      {{if $b.DigitalInterrupts }}
      <tr><th colspan="2">DigitalInterrupts</th></tr>
      {{ range $i := $b.DigitalInterrupts }}
      <tr><th>{{$i.Name}}</th><td id="board_di_{{$b.Name}}_{{$i.Name}}"></td></tr>
      {{ end }}
      {{end}}

      {{if $b.Servos}}
      <tr><th colspan="2">Servos</th></tr>
      {{ range $i := $b.Servos }}
      <tr><th>{{$i.Name}}</th><td id="board_s_{{$b.Name}}_{{$i.Name}}"></td></tr>
      <tr>
        <td></td>
        <td>
          <button onclick="boardAction('servo', '{{$b.Name}}', '{{$i.Name}}', 'delta=-10')">-10</button>
          <button onclick="boardAction('servo', '{{$b.Name}}', '{{$i.Name}}', 'delta=-1')">-1</button>
          <button onclick="boardAction('servo', '{{$b.Name}}', '{{$i.Name}}', 'delta=1')">+1</button>
          <button onclick="boardAction('servo', '{{$b.Name}}', '{{$i.Name}}', 'delta=10')">+10</button>
        </td>
      </tr>
      {{ end }}      
      {{end}}
      
    </table>
    <script>updateBoardView('{{$b.Name}}');</script>
    {{end}} <!-- end Boards -->
    
    
    <div id="res"></div>
    
  </body>
</html>

{{define "C"}}
<li>
  {{ index . 1 }}
  <button onclick="armInc({{ index . 0 }}, '{{index . 1 }}={{mul 10 (index . 2)}}')">++</button>
  <button onclick="armInc({{ index . 0 }}, '{{index . 1 }}={{index . 2}}')">+</button>
  <button onclick="armInc({{ index . 0 }}, '{{index . 1 }}=-{{index . 2}}')">-</button>
  <button onclick="armInc({{ index . 0 }}, '{{index . 1 }}=-{{mul 10 (index . 2)}}')">--</button>
  <span id='arm_c_{{index . 0}}_{{index . 1}}'></span>
  <input id='arm_ci_{{index . 0}}_{{index . 1}}'>
</li>
{{end}}

{{define "J"}}
<li>
  Joint {{index . 1}}
  <button onclick="armInc({{ index . 0}}, 'j{{index . 1}}=10', 'joint' )">++</button>
  <button onclick="armInc({{ index . 0}}, 'j{{index . 1}}=1', 'joint' )">+</button>
  <button onclick="armInc({{ index . 0}}, 'j{{index . 1}}=-1', 'joint' )">-</button>
  <button onclick="armInc({{ index . 0}}, 'j{{index . 1}}=-10', 'joint' )">--</button>
  <span id='arm_j_{{index . 0}}_{{index . 1}}'></span>
  <input id='arm_ji_{{index . 0}}_{{index . 1}}'>
</li>
{{end}}
