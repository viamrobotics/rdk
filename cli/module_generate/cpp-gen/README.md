# Viam C++ SDK module template generator

This is a module template generator for the Viam C++ SDK. What that means is it will generate static _template_
files which can then be turned into Viam C++ module stub code by performing text substitution.

 Very schematically, the basic inputs are
- C++ SDK build directory containing a `compile_commands.json` (automatically generated by the SDK CMake project)
- C++ SDK source of the resource you want to implement.

## Building

This project is implemented using Clang [LibTooling](https://clang.llvm.org/docs/LibTooling.html) to traverse the C++ AST and generate a stub implementation. The LibTooling interface is
unstable so we pin our dependency to Clang 15, as this is the release used by the various SDK docker images used in CI. To install

- Mac with homebrew: `brew install llvm@15`
- Linux: See `Dockerfile.debian.bookworm` for how to add the LLVM toolchain 15 apt repo and then `apt-get install clang-15 llvm-15-dev libclang-15-dev`

This generator also needs to be pointed to a generated CMake build directory for the SDK, and as such inherits the [SDK's depdendencies](https://github.com/viamrobotics/viam-cpp-sdk/blob/main/BUILDING.md). Note the SDK itself does not need to have been compiled, it just needs to be compile-_able_.

Next let's make a build directory:

```shell
mkdir build && cd build
```

When generating the build, you should point CMake to your Clang 15 install. For example

```shell
# Linux apt install
cmake .. -G Ninja -DLLVM_DIR=/usr/lib/llvm-15
```

or

```shell
# Mac brew install
cmake .. -G Ninja -DLLVM_DIR=/opt/homebrew/opt/llvm@15
```

### Docker build

For convenience there are some Docker files adapted from the C++ SDK Docker development images, using the same multi-stage approach. First generate the base image:

```shell
docker build -t gen-base/bookworm -f ./Dockerfile.debian.bookworm .
```

You are free to tag the image whatever you like with the `-t` argument.

Then on top of this image, we generate an SDK build tree and build the command line generator.

```shell
docker build --build-arg SDK_GIT_TAG=releases/v0.2.0 --build-arg BASE_TAG=gen-base/bookworm -t gen-dev/bookworm -f Dockerfile.gen-build .
```

The `BASE_TAG` arg specifies whatever tag name you used for the base image in the previous step, and `SDK_GIT_TAG` selects an SDK release to build against, which will be cloned from the Viam remote. Then explore in the container with

```shell
docker run -it --entrypoint /bin/bash gen-dev/bookworm
```

## Usage

The CLI inherits the interface of a Clang command line tool, so the interface is

```shell
./cl_gen -p <build_dir> <component-src-file>
```

So for example if you are using the Docker build and want to implement a `MovementSensor`,

```shell
cd build
./cl_gen -p /viam-cpp-sdk/build/ /viam-cpp-sdk/src/viam/sdk/components/movement_sensor.cpp
```
