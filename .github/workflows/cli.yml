name: Viam CLI

on:
  workflow_dispatch:
    inputs:
      release_type:
        required: true
        type: string
        default: latest
  workflow_call:
    inputs:
      release_type:
        required: true
        type: string
    secrets:
      GCP_CREDENTIALS:
        required: true

jobs:
  viam-cli:
    strategy:
      matrix:
        include:
        - goos: linux
          goarch: amd64
        - goos: linux
          goarch: arm64
        - goos: darwin
          goarch: amd64
        - goos: darwin
          goarch: arm64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-go@v4
      with:
        go-version: '1.20.x'

    - name: Check out code
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
      uses: actions/checkout@v3
    - name: Check out PR branch code
      if: github.event_name == 'pull_request_target'
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: build
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: go build -ldflags="-X 'go.viam.com/rdk/config.Version=${{ github.ref_name }}'" ./cli/viam

    - name: Authorize GCP Upload
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
    - name: upload
      uses: google-github-actions/upload-cloud-storage@v0.10.4
      with:
        headers: "cache-control: no-cache"
        path: 'viam'
        destination: 'packages.viam.com/apps/viam-cli/${{ inputs.release_type }}-${{ matrix.goos }}-${{ matrix.goarch }}'

    # publish tagged version for stable
    - name: Set up Cloud SDK
      if: inputs.release_type == 'stable'
      uses: google-github-actions/setup-gcloud@v1
    - name: Publish AppImage
      if: inputs.release_type == 'stable'
      run: |
        gsutil mv 'gs://packages.viam.com/apps/viam-cli/${{ inputs.release_type }}-${{ matrix.goos }}-${{ matrix.goarch }}/viam' 'gs://packages.viam.com/apps/viam-cli/${{ github.ref_name }}-${{ matrix.goos }}-${{ matrix.goarch }}/viam'
