name: full-static

on:
  workflow_dispatch:
    inputs:
      version:
        description: a channel or version tag for upload
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: a channel or version tag for upload
        required: false
        type: string
    secrets:
      GCP_CREDENTIALS:
        required: true
  pull_request: # DONOTMERGE

jobs:
  full-static:
    strategy:
      fail-fast: false
      matrix:
        include:
        - arch: ubuntu-latest
          cpu: x86_64
        # - arch: buildjet-2vcpu-ubuntu-2204-arm
        #   image: ghcr.io/viamrobotics/antique2:arm64-cache
        #   platform: linux/arm64
    runs-on: ${{ matrix.arch }}
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ contains(github.event_name, 'pull_request') && github.event.pull_request.head.sha || github.ref }}
    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: build
      run: make full-static

    - name: test with musl
      run: docker run --rm -v $PWD:/ext-mnt alpine:latest /ext-mnt/server

    - uses: actions/upload-artifact@v4
      with:
        name: full-static-${{ matrix.platform }}
        path: server

    - uses: google-github-actions/auth@v2
      if: inputs.version
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - uses: google-github-actions/upload-cloud-storage@v2
      if: inputs.version
      with:
        headers: "cache-control: no-cache"
        path: server
        destination: packages.viam.com/apps/viam-server/viam-server-portable-${{ inputs.version }}-${{ matrix.cpu }}
        parent: false
    # - name: Set up Cloud SDK
    #   uses: google-github-actions/setup-gcloud@v1

    # - name: Publish Static Binary
    #   run: |
    #     gsutil mv "gs://packages.viam.com/apps/viam-server/testing/static/${{ needs.static_test.outputs.date }}/${{ github.sha }}/*" "gs://packages.viam.com/apps/viam-server/"

    # todo: what is this / do I need it for this build?
    # - name: Publish Subsystem Metadata
    #   run: |
    #     gsutil mv "gs://packages.viam.com/apps/viam-subsystems/testing/viam-server/${{ needs.static_test.outputs.date }}/${{ github.sha }}/*" "gs://packages.viam.com/apps/viam-subsystems/"

    # - name: Output Summary
    #   run: |
    #     channel="${{ github.ref_name }}"
    #     # we call our main branch releases "latest"
    #     if [ "$channel" == "main" ]; then
    #       channel="latest"
    #     fi
    #     echo "### Built Static Binaries for ${channel}" >> $GITHUB_STEP_SUMMARY
    #     echo "- arm64: https://storage.googleapis.com/packages.viam.com/apps/viam-server/viam-server-${channel}-aarch64" >> $GITHUB_STEP_SUMMARY
    #     echo "- x86_64: https://storage.googleapis.com/packages.viam.com/apps/viam-server/viam-server-${channel}-x86_64" >> $GITHUB_STEP_SUMMARY
    #     echo "" >> $GITHUB_STEP_SUMMARY
